# `repository`

**Type**: Object with `id` and `authorized_form_of_name` fields

---

The `repository` field in AtoM contains information about the archival institution that holds the record. Previously this was just a string (the authorized form of name), but now the API returns an object with the internal database ID and the authorized form of name.

We model this using a **`rico:RecordResourceHoldingRelation`** entity, which is an n-ary relation that formally represents the relationship between a record and the institution that holds it. This relation uses the proper RiC-O n-ary structure to link a record to a `rico:CorporateBody` (the repository).

## Enhanced Repository Processing

Our implementation uses a **two-phase approach** to process repositories:

1. **Phase 1**: Process all other informationobject metadata first
2. **Phase 2**: Process repository last, using detailed repository data from the AtoM repository API

This approach ensures that:
- Repository entities are **deduplicated** across multiple records
- **Rich repository metadata** is captured from the dedicated repository API endpoint
- **Consistent entity relationships** are maintained

### Repository Deduplication Strategy

Each repository is identified by a unique `id` field from the AtoM informationobject API. Before creating a new repository entity, we:

1. Check if a repository with that `id` already exists in the database
2. If exists: reuse the existing repository entity
3. If not exists: fetch detailed repository data and create full entity structure

### Repository API Integration

When a new repository is encountered, we fetch detailed information from:
```
GET /api/repositories/{id}
```

This provides rich ISDIAH metadata including:
- Multiple name variants (authorized, parallel, other names)
- Reference codes and identifiers
- Repository types and classifications
- Contact information and services
- Detailed descriptive information

## RiC-O Entity Model

### Core Entities

1. **`rico:RecordResourceHoldingRelation`** - The n-ary relationship between record and repository
2. **`rico:CorporateBody`** - The holding institution
3. **`rico:AgentName`** - Multiple name entities for each repository
4. **`rico:Identifier`** - Reference codes and other identifiers
5. **`rico:CorporateBodyType`** - Repository type classifications
6. **`rico:Instantiation`** - Digital instantiation metadata

### Name Variants

Each repository can have multiple name entities linked via `rico:hasOrHadAgentName`:

- **Authorized form of name** (ISDIAH 5.1.2) - Primary name
- **Parallel names** (ISDIAH 5.1.3) - Alternative forms in different languages
- **Other names** (ISDIAH 5.1.4) - Additional variants

Each name entity includes:
- `rico:textualValue` - The actual name text
- `rdfs:label` - Descriptive label indicating the name type

### ISDIAH Field Mapping

All ISDIAH fields from the repository API are processed and stored:

#### Direct RiC-O Entity Mappings
- **`identifier`** (ISDIAH 5.1.1) → `rico:Identifier` entity with `rico:textualValue`
- **`authorized_form_of_name`** (ISDIAH 5.1.2) → `rico:AgentName` entity
- **`parallel_names`** (ISDIAH 5.1.3) → Multiple `rico:AgentName` entities
- **`other_names`** (ISDIAH 5.1.4) → Multiple `rico:AgentName` entities
- **`types`** → `rico:CorporateBodyType` entities (shared, deduplicated)

#### Note Property Mappings
Fields that don't have direct RiC-O equivalents are stored as `rico:note` properties with field name prefixes:

- **`history`** (ISDIAH 5.3.1) → `rico:note` with value `"history: {text}"`
- **`geocultural_context`** (ISDIAH 5.3.2) → `rico:note` with value `"geocultural_context: {text}"`
- **`mandates`** (ISDIAH 5.3.3) → `rico:note` with value `"mandates: {text}"`
- **`administrative_structure`** (ISDIAH 5.3.4) → `rico:note` with value `"administrative_structure: {text}"`
- **`collecting_policies`** (ISDIAH 5.3.5) → `rico:note` with value `"collecting_policies: {text}"`
- **`buildings`** (ISDIAH 5.3.6) → `rico:note` with value `"buildings: {text}"`
- **`holdings`** (ISDIAH 5.3.7) → `rico:note` with value `"holdings: {text}"`
- **`finding_aids`** (ISDIAH 5.3.8) → `rico:note` with value `"finding_aids: {text}"`
- **`opening_times`** (ISDIAH 5.4.1) → `rico:note` with value `"opening_times: {text}"`
- **`access_conditions`** (ISDIAH 5.4.2) → `rico:note` with value `"access_conditions: {text}"`
- **`accessibility`** (ISDIAH 5.4.3) → `rico:note` with value `"accessibility: {text}"`
- **`research_services`** (ISDIAH 5.5.1) → `rico:note` with value `"research_services: {text}"`
- **`reproduction_services`** (ISDIAH 5.5.2) → `rico:note` with value `"reproduction_services: {text}"`
- **`public_areas`** (ISDIAH 5.5.3) → `rico:note` with value `"public_areas: {text}"`
- **`maintenance_notes`** (ISDIAH 5.6.9) → `rico:note` with value `"maintenance_notes: {text}"`

#### Array Field Mappings
Array fields are joined with semicolons and stored as note properties:

- **`thematic_areas`** → `rico:note` with value `"thematic_areas: {joined array}"`
- **`geographic_subregions`** → `rico:note` with value `"geographic_subregions: {joined array}"`
- **`languages`** → `rico:note` with value `"languages: {joined array}"`
- **`scripts`** → `rico:note` with value `"scripts: {joined array}"`

#### Special Contact Information Mapping
The `primary_contact` object is formatted as a markdown note with all contact fields:

```markdown
## Primary contact

**Contact name:** {contact_name}
**Contact type:** {contact_type}
**Street address:** {street_address}
**City:** {city}
**Region:** {region}
**Country:** {country_name}
**Postal code:** {postal_code}
**Telephone:** {telephone}
**Fax:** {fax}
**Email:** {email}
**URL:** {url}
**Note:** {note}
```

## RiC-O Entity Relationship Diagram

```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
rico:RecordSet/Record/RecordPart
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
rico:RecordResourceHoldingRelation
• rico:relationHasTarget ↑
• rico:relationHasSource ↓
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
rico:CorporateBody
• rico:identifier → "{repository.id}"@en
• rico:note → "{field_name}: {text}"@en (multiple)
• rico:hasOrHadAgentName ↓ (multiple)
• rico:hasOrHadIdentifier ↓
• rico:hasOrHadCorporateBodyType ↓ (multiple)
• rico:hasOrHadDigitalInstantiation ↓
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
rico:AgentName (multiple per repository)
• rico:textualValue → "{name text}"@en
• rdfs:label → "{name type description}"@en
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
rico:Identifier
• rico:textualValue → "{identifier}"@en
• rico:hasIdentifierType → rico:IdentifierType
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
rico:CorporateBodyType (shared entities)
• rdfs:label → "{type name}"@en
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
rico:Instantiation
• rico:carrierType → "Digital"@en
• rico:structure → "Structured metadata, held in Access to Memory (AtoM) database"@en
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### Example

```turtle
# Example record set entity
:RecordSet_123 a rico:RecordSet .

# Define the repository (CorporateBody) entity with rich metadata
:CorporateBody_TrinityCollege a rico:CorporateBody ;
  rico:identifier "473"@en ;
  rico:note "history: Trinity College Library was established in 1591..."@en ;
  rico:note "geographic_subregions: Europe"@en ;
  rico:note "thematic_areas: Education; Arts and Culture"@en ;
  rico:note "languages: English; French"@en ;
  rico:note "scripts: Arabic; Latin"@en ;
  rico:note "## Primary contact\n\n**Contact name:** Archives Team\n**City:** Cambridge\n**Country:** GB"@en ;
  rico:hasOrHadAgentName :Name_TrinityCollege_Authorized ;
  rico:hasOrHadAgentName :Name_TrinityCollege_Parallel ;
  rico:hasOrHadIdentifier :Identifier_TrinityCollege ;
  rico:hasOrHadCorporateBodyType :CorporateBodyType_Educational ;
  rico:hasOrHadCorporateBodyType :CorporateBodyType_Private ;
  rico:hasOrHadDigitalInstantiation :Instantiation_TrinityCollege .

# Authorized form of name
:Name_TrinityCollege_Authorized a rico:AgentName ;
  rico:textualValue "Trinity College Library, Cambridge - ISDIAH 5.1.2"@en ;
  rdfs:label "Authorized form of name (ISDIAH 5.1.2)"@en .

# Parallel name
:Name_TrinityCollege_Parallel a rico:AgentName ;
  rico:textualValue "Parallel form(s) of name 1 - ISDIAH 5.1.3"@en ;
  rdfs:label "Parallel name (ISDIAH 5.1.3)"@en .

# Repository identifier
:Identifier_TrinityCollege a rico:Identifier ;
  rico:textualValue "TRN1 - ISDIAH 5.1.1"@en ;
  rico:hasIdentifierType :IdentifierType_RepositoryIdentifier .

:IdentifierType_RepositoryIdentifier a rico:IdentifierType ;
  rico:textualValue "Repository identifier"@en .

# Repository types
:CorporateBodyType_Educational a rico:CorporateBodyType ;
  rdfs:label "Educational"@en .

:CorporateBodyType_Private a rico:CorporateBodyType ;
  rdfs:label "Private"@en .

# Digital instantiation
:Instantiation_TrinityCollege a rico:Instantiation ;
  rico:carrierType "Digital"@en ;
  rico:structure "Structured metadata, held in Access to Memory (AtoM) database"@en .

# Define the holding relation using n-ary structure
:RecordResourceHoldingRelation_123 a rico:RecordResourceHoldingRelation ;
  rico:relationHasSource :CorporateBody_TrinityCollege ;
  rico:relationHasTarget :RecordSet_123 .
```

### CorporateBodyType Deduplication

Repository types are stored as shared `rico:CorporateBodyType` entities that are reused across multiple repositories:

- Each unique type name creates a new `CorporateBodyType` entity
- Subsequent repositories with the same type link to the existing entity
- Types are stored with `rdfs:label` containing the type name

### Notes
- The properties used in the above example follow the RiC-O n-ary relation structure. The `rico:relationHasSource` and `rico:relationHasTarget` properties connect the relation to the source (repository) and target (record) entities.*